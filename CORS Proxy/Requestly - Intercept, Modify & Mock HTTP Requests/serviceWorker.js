!function(){"use strict";var e,t,a,s,r,n,o,i,c,u,d,l;!function(e){e.GROUP="group",e.RULE="rule"}(e||(e={})),function(e){e.ACTIVE="Active",e.INACTIVE="Inactive"}(t||(t={})),function(e){e.REDIRECT="Redirect",e.CANCEL="Cancel",e.REPLACE="Replace",e.HEADERS="Headers",e.USERAGENT="UserAgent",e.SCRIPT="Script",e.QUERYPARAM="QueryParam",e.RESPONSE="Response",e.REQUEST="Request",e.DELAY="Delay"}(a||(a={})),function(e){e.URL="Url",e.HOST="host",e.PATH="path"}(s||(s={})),function(e){e.EQUALS="Equals",e.CONTAINS="Contains",e.MATCHES="Matches",e.WILDCARD_MATCHES="Wildcard_Matches"}(r||(r={})),function(e){e.PAGE_DOMAINS="pageDomains",e.REQUEST_METHOD="requestMethod",e.RESOURCE_TYPE="resourceType",e.REQUEST_PAYLOAD="requestPayload"}(n||(n={})),function(e){e.XHR="xmlhttprequest",e.JS="script",e.CSS="stylesheet",e.Image="image",e.Media="media",e.Font="font",e.WebSocket="websocket",e.MainDocument="main_frame",e.IFrameDocument="sub_frame"}(o||(o={})),function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE",e.PATCH="PATCH",e.OPTIONS="OPTIONS",e.CONNECT="CONNECT",e.HEAD="HEAD"}(i||(i={})),function(e){e.CUSTOM="custom",e.ALL_PAGES="allPages"}(c||(c={})),function(e){e.SESSION_RECORDING_CONFIG="sessionRecordingConfig"}(u||(u={})),function(e){e.JS="js",e.CSS="css"}(d||(d={})),function(e){e.URL="url",e.CODE="code"}(l||(l={}));var E="https://app.requestly.io",p=["https://app.requestly.com"],h={browser:"chrome",storageType:"local",contextMenuContexts:["browser_action"],env:"prod",WEB_URL:E,SESSIONS_URL:"https://app.requestly.io/sessions",OTHER_WEB_URLS:p,logLevel:"info"};const m=e=>{const t=e.match(new RegExp("^/(.+)/(|i|g|ig|gi)$"));if(!t)return null;try{return new RegExp(t[1],t[2])}catch(e){return null}},R=(e,t)=>{e.startsWith("/")||(e=`/${e}/`);const a=m(e);return a?.test(t)},g=e=>"/^"+e.replace(/([?.-])/g,"\\$1").replace(/(\*)/g,"(.*)")+"$/",T=(e,t)=>{const a=((e,t)=>{let a=null;try{a=new URL(e)}catch(e){}if(a)switch(t){case s.URL:return e;case s.HOST:return a.host;case s.PATH:return a.pathname}})(t,e.key),n=e.value;if(!(e.isActive??!0))return!1;if(!a)return!1;switch(e.operator){case r.EQUALS:if(n===a)return!0;break;case r.CONTAINS:if(-1!==a.indexOf(n))return!0;break;case r.MATCHES:return R(n,a);case r.WILDCARD_MATCHES:return((e,t)=>{const a=g(e);return R(a,t)})(n,a)}return!1},I=(e,t)=>{if(!e)return!0;if("object"==typeof e&&0===Object.keys(e).length)return!0;if(!t||"object"!=typeof t)return!1;if(0===Object.keys(t).length)return!1;const a=e?.key,s=e?.value;if(a&&void 0!==typeof s){const r=A(t,a),n=e?.operator;let o="";if("object"==typeof r||(o=r?.toString()),!n||"Equals"===n)return o===s;if("Contains"===n)return o.includes(s)}return!1},S=function(e,t){if(ge(t.initiator)||ge(t.url))return{};const a=e?.pairs?.find((e=>T(e.source,t.url)&&function(e,t){if(!e||!t||Array.isArray(e)&&0===e?.length)return!0;const a=Array.isArray(e)?e[0]:e;return Object.entries(a).every((([e,a])=>{switch(e){case n.PAGE_DOMAINS:return a.some((e=>{const a=Te(t.initiator);return(a?.hostname||"").endsWith(e)}));case n.REQUEST_METHOD:return a.includes(t.method);case n.RESOURCE_TYPE:return a.includes(t.type);case n.REQUEST_PAYLOAD:return I(a,t.requestData);default:return!0}}))}(e.source.filters,t)));if(!a)return{isApplied:!1};return{isApplied:!0,matchedPair:a,destinationUrl:b(a,e.ruleType,t)}},f=function(e,t){return t.forEach((function(t,a){0!==a&&(t=t||"",e=e.replace(new RegExp("[$]"+a,"g"),t))})),e},b=(e,t,s)=>{switch(t){case a.REPLACE:const t=s.url.replace(e.from,e.to);return t===s.url?null:t;case a.REDIRECT:if(e.source.operator===r.MATCHES){const t=m(e.source.value)?.exec(s.url);return t?f(e.destination,t):e.destination}if(e.source.operator===r.WILDCARD_MATCHES){const t=e.source.value,a=g(t),r=m(a)?.exec(s.url);return r?f(e.destination,r):e.destination}return e.destination;default:return null}},y=(e,t)=>{for(const a of e){const e=S(a,t);if(e.isApplied)return e}return null},A=(e,t)=>{if(!t)return;const a=t.split(".");try{for(let t=0;t<a.length-1;t++)e=e[a[t]];return e[a[a.length-1]]}catch(e){}},D="getRulesAndGroups",_="getTabSession",O="handshakeClient",w="getAPIResponse",C="getExecutedRules",L="checkIfNoRulesPresent",N="startRecordingExplicitly",v="startRecordingOnUrl",U="stopRecording",P="watchRecording",x="checkIfExtensionEnabled",q="toggleExtensionStatus",M="cacheRecordedSessionOnPageUnload",k="initSessionRecorder",H="clientPageLoaded",G="onBeforeAjaxRequest",F="onErrorOccurred",B="saveTestRuleResult",j="notifyTestRuleReportUpdated",V="testRuleOnUrl",W="ruleExecuted",X="notifyRecordUpdatedInPopup",$="ruleSaveError",Q="isExtensionBlockedOnTab",Y="notifySessionRecordingStarted",J="notifySessionRecordingStopped",z="getTabSession",K="startRecording",Z="stopRecording",ee="startExplicitRuleTesting",te="startImplicitRuleTesting",ae="notifyRuleExecuted",se="notifyRecordUpdated",re="local",ne="testReports",oe="blocked_domains",ie=async()=>{const e=await(async()=>new Promise((e=>{chrome.storage[re].get(null,e)})))();return Object.values(e).filter((e=>!!e))},ce=async(e,t)=>{await(async e=>{await chrome.storage[re].set(e)})({[e]:t})},ue=async e=>new Promise((t=>{chrome.storage[re].get(e,(a=>t(a[e])))}));var de;!function(e){e[e.MODIFIED=0]="MODIFIED",e[e.CREATED=1]="CREATED",e[e.DELETED=2]="DELETED"}(de||(de={}));const le=(e,t)=>{chrome.storage.onChanged.addListener(((a,s)=>{if(s===re){const s=[];Object.entries(a).forEach((([t,a])=>{let r,n;if(void 0!==a.newValue)r=void 0!==a.oldValue?de.MODIFIED:de.CREATED,n=a.newValue;else{if(void 0===a.oldValue)return;r=de.DELETED,n=a.oldValue}e?.changeTypes?.length&&!e.changeTypes.includes(r)||e?.keyFilter&&t!==e.keyFilter||e?.valueFilter&&!e.valueFilter(n)||s.push({changeType:r,key:t,...a})})),s.length&&t(s)}}))};var Ee;!function(e){e.IS_EXTENSION_ENABLED="isExtensionEnabled",e.EXTENSION_RULES_COUNT="extensionRulesCount",e.TEST_SCRIPT="testScript"}(Ee||(Ee={}));const pe=e=>`rq_var_${e}`,he=async(e,t)=>{await ce(pe(e),t)},me=(e,t)=>{le({keyFilter:pe(e),changeTypes:[de.MODIFIED]},(e=>{t(e[e.length-1].newValue,e[0].oldValue)}))},Re=()=>[...new Set([h.WEB_URL,...h.OTHER_WEB_URLS])],ge=e=>[...Re().map((e=>({key:s.URL,operator:r.CONTAINS,value:e}))),{key:s.URL,operator:r.CONTAINS,value:"__rq"}].some((t=>T(t,e))),Te=e=>{try{return new URL(e)}catch(e){return null}},Ie=async()=>await(async(e,t)=>await ue(pe(e))??t)(Ee.IS_EXTENSION_ENABLED,!0);let Se=null;const fe=async()=>{const e=await ue(oe);Se=e??[]},be=async()=>Se||(await fe(),Se),ye=async e=>{const t=await be();return t?.some((t=>T({key:s.HOST,value:`/^(.+.)?${t}$/i`,operator:r.MATCHES},e)))},Ae=e=>{le({keyFilter:oe,changeTypes:[de.MODIFIED]},(()=>{fe().then((()=>{e?.()}))}))},De=t=>t&&(!!t.ruleType||t.objectType===e.RULE),_e=t=>t&&t.objectType===e.GROUP,Oe=async()=>(await ie()).filter(De),we=async()=>(await ie()).filter(_e),Ce=e=>{le({valueFilter:De},(a=>{a.some((({changeType:e,oldValue:a,newValue:s})=>e===de.CREATED&&s.status===t.ACTIVE||(e===de.DELETED&&a.status===t.ACTIVE||e===de.MODIFIED)))&&e()})),le({valueFilter:_e,changeTypes:[de.MODIFIED]},(t=>{t.some((({oldValue:e,newValue:t})=>e.status!==t.status))&&e()}))};const Le=new class{rules=[];groups=[];isInitialized=!1;listeners={};updateCachedRules=async()=>{this.rules=await Oe(),this.groups=await we(),this.isInitialized=!0};constructor(){this.updateCachedRules(),Ce((()=>{this.updateCachedRules().then((()=>{this.listeners&&Object.values(this.listeners).forEach((e=>e?.()))}))}))}onRuleOrGroupChange=e=>{const t=Date.now();return this.listeners[t]=e,()=>{this.listeners[t]&&delete this.listeners[t]}};getAllRules=async()=>this.isInitialized?this.rules:Oe();getAllGroups=async()=>this.isInitialized?this.groups:we();getRule=async e=>this.getAllRules().then((t=>t.find((t=>t.id===e))));getRules=async e=>this.getAllRules().then((t=>t.filter((t=>e.includes(t.id)))));getEnabledRules=async e=>{const a=await this.getAllRules(),s=await this.getAllGroups();return a.filter((a=>{if(!a.status||a.status===t.INACTIVE)return!1;if(e&&a.ruleType!==e)return!1;if(!a.groupId)return!0;return s.find((e=>e.id===a.groupId)).status===t.ACTIVE}))}},Ne=[E,...p].map((e=>{try{const t=new URL(e);return`${t.protocol}//${t.host}/*`}catch(t){return console.error(`Invalid URL: ${e}`,t),null}})).filter((e=>!!e)),ve=e=>[`*://${e}/*`,`*://*.${e}/*`],Ue=[{id:"page-script-ajaxInterceptor",js:["page-scripts/ajaxRequestInterceptor.ps.js"],world:"MAIN",allFrames:!0,persistAcrossSessions:!1,matches:["http://*/*","https://*/*"],runAt:"document_start",excludeMatches:Ne},{id:"page-script-sessionRecorder",js:["page-scripts/sessionRecorderHelper.ps.js"],world:"MAIN",persistAcrossSessions:!1,matches:["http://*/*","https://*/*"],runAt:"document_start"}],Pe=async()=>(console.log("[unregisterClientScript]"),chrome.scripting.unregisterContentScripts({ids:Ue.map((e=>e.id))}).then((()=>{console.log("[unregisterClientScript]","unregisterClientScript complete"),chrome.scripting.getRegisteredContentScripts().then((e=>console.log("[unregisterClientScript]","registered content scripts",e)))})).catch((e=>console.warn("[unregisterClientScript]","unexpected error",e)))),xe=async e=>{console.log("[initClientHandler.setupClientScript]",{isExtensionStatusEnabled:e}),e?(async()=>{const e=await be(),t=e.flatMap(ve).filter((e=>!!e));console.log("[registerClientScript]",{blockedDomains:e});const a=Ue.map((e=>({...e,excludeMatches:[...e.excludeMatches??[],...t]})));chrome.scripting.registerContentScripts(a).then((()=>{console.log("[registerClientScript]"),chrome.scripting.getRegisteredContentScripts().then((e=>console.log("[registerClientScript]","registered content scripts",e)))})).catch((e=>console.warn("[unregisterClientScript]","unexpected error",e)))})():Pe()},qe=e=>{const t="__REQUESTLY__";window[t]=window[t]||{},Object.keys(e).map((a=>{window[t][a]=e[a]}))},Me=async(e,t)=>{const s=await Le.getEnabledRules(a.REQUEST);(async(e,t,a)=>{const s={tabId:e};void 0!==a?s.frameIds=[a]:s.allFrames=!0,chrome.scripting.executeScript({target:s,func:qe,args:[t],injectImmediately:!0,world:"MAIN"},(()=>{}))})(e,{responseRules:await Le.getEnabledRules(a.RESPONSE),requestRules:s,delayRules:await Le.getEnabledRules(a.DELAY)},t)};var ke;!function(e){e.TAB="tabData",e.PAGE="pageData"}(ke||(ke={}));const He=new class{map={};constructor(){this.initTabs(),this.addEventListeners()}initTabs(){chrome.tabs.query({},(e=>{this.map={},e.forEach((e=>this.addOrUpdateTab(e)))}))}addEventListeners(){chrome.tabs.onCreated.addListener((e=>this.addOrUpdateTab(e))),chrome.tabs.onRemoved.addListener((e=>this.removeTab(e))),chrome.tabs.onReplaced.addListener(((e,t)=>{this.removeTab(t),chrome.tabs.get(e,(e=>this.addOrUpdateTab(e)))})),chrome.tabs.onUpdated.addListener(((e,t,a)=>{const s=this.getTab(e);if(!s)return void this.addOrUpdateTab(a);const r={...a,[ke.TAB]:s[ke.TAB]||{},[ke.PAGE]:s[ke.PAGE]||{}};this.addOrUpdateTab(r)})),chrome.webRequest.onBeforeRequest.addListener((e=>{if("main_frame"===e.type){const t=this.getTab(e.tabId)||{id:e.tabId};this.addOrUpdateTab({...t,url:e.url})}}),{urls:["<all_urls>"]}),chrome.webNavigation.onCommitted.addListener((e=>{0===e.frameId&&this.resetPageData(e.tabId)})),chrome.webNavigation.onDOMContentLoaded.addListener((e=>{if(0===e.frameId){this.getTab(e.tabId)&&this.sendMessage(e.tabId,{action:H})}}))}sendMessage(e,...t){chrome.tabs.sendMessage(e,...t)}addOrUpdateTab(e){e.id!==chrome.tabs.TAB_ID_NONE&&(this.map[e.id]={...this.map[e.id],...e})}createNewTab(e,t,a){chrome.tabs.create({url:e,openerTabId:t},(e=>{a(e)}))}removeTab(e){const t=this.getData(e,Ge.SESSION_RULES_MAP);let a=[];if(t){for(const e of Object.values(t))a.push(...Object.values(e));chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:a})}delete this.map[e]}getTabs(){return this.map}getTab(e){return this.getTabs()[e]}getTabUrl(e){var t=this.getTab(e);return t&&t.url}focusTab(e){var t=this.getTab(e);if(t&&t.windowId)try{return chrome.windows.update(t.windowId,{focused:!0},(()=>{chrome.tabs.highlight({windowId:t.windowId,tabs:t.index})})),!0}catch(e){return!1}return!1}closeTab(e){chrome.tabs.remove(e)}ensureTabLoadingComplete(e){return new Promise((async(t,a)=>{const s=await chrome.tabs.get(e);if(s)if("complete"===s.status)t();else{const a=(s,r)=>{s===e&&"complete"===r.status&&(chrome.tabs.onUpdated.removeListener(a),t())};chrome.tabs.onUpdated.addListener(a)}else a()}))}setDataForScope(e,t,a,s){const r=this.getTab(t);r?r[e]?r[e][a]=s:r[e]={[a]:s}:this.addOrUpdateTab({id:t,[ke.TAB]:{[a]:s}})}getDataForScope(e,t,a,s){const r=this.getTab(t);if(r)return r[e]?.[a]||s}removeDataForScope(e,t,a){const s=this.getTab(t);s&&s[e]&&delete s[e][a]}setData(e,t,a){this.setDataForScope(ke.TAB,e,t,a)}getData(e,t,a){return this.getDataForScope(ke.TAB,e,t,a)}removeData(e,t){this.removeDataForScope(ke.TAB,e,t)}setPageData(e,t,a){this.setDataForScope(ke.PAGE,e,t,a)}getPageData(e,t,a){return this.getDataForScope(ke.PAGE,e,t,a)}removePageData(e,t){this.removeDataForScope(ke.PAGE,e,t)}resetPageData(e){const t=this.getTab(e);t?.[ke.PAGE]&&(t[ke.PAGE]={})}};self.tabService=He;const Ge={SESSION_RECORDING:"sessionRecording",SESSION_RULES_MAP:"sessionRulesMap",TEST_RULE_DATA:"testRuleData",APPLIED_RULE_DETAILS:"appliedRuleDetails",RULES_EXECUTION_LOGS:"rulesExecutionLogs"};const Fe=new class{#e=!1;#t={DEFAULT:"/resources/images/48x48.png",DISABLED:"/resources/images/48x48_greyscale.png",BLOCKED:"/resources/images/48x48_blocked.png",RULE_EXECUTED:"/resources/images/48x48_green.png",DEFAULT_WITH_REC:"/resources/images/48x48_rec.png",RULE_EXECUTED_WITH_REC:"/resources/images/48x48_green_rec.png"};#a={PAGE_DATA_ICON_CONFIG:"extensionIconConfig"};constructor(){chrome.tabs.onUpdated.addListener(((e,t,a)=>{ye(a.url).then((t=>{t?this.markExtensionBlocked(e):this.#s(e)}))}))}#r(){return{ruleExecuted:!1,isRecording:!1}}#n(e){return this.#e?this.#t.DISABLED:e.ruleExecuted?e.isRecording?this.#t.RULE_EXECUTED_WITH_REC:this.#t.RULE_EXECUTED:e.isRecording?this.#t.DEFAULT_WITH_REC:e.isBlocked?this.#t.BLOCKED:this.#t.DEFAULT}#s(e,t,a){let s=He.getPageData(e,this.#a.PAGE_DATA_ICON_CONFIG)??this.#r();t&&s[t]!==a&&(s={...s,[t]:a}),He.setPageData(e,this.#a.PAGE_DATA_ICON_CONFIG,s),this.#o(this.#n(s),e)}#i(){const e=He.getTabs();Object.values(e).forEach((e=>this.#s(e.id)))}#o(e,t){void 0===t?chrome.action.setIcon({path:e}):chrome.action.setIcon({path:e,tabId:t})}markExtensionEnabled=()=>{this.#e=!1,this.#o(this.#t.DEFAULT),this.#i()};markExtensionDisabled=()=>{this.#e=!0,this.#o(this.#t.DISABLED),this.#i()};markRuleExecuted(e){this.#s(e,"ruleExecuted",!0)}markRecording(e){this.#s(e,"isRecording",!0)}markNotRecording(e){this.#s(e,"isRecording",!1)}markExtensionBlocked(e){this.#s(e,"isBlocked",!0)}};var Be,je;!function(e){e.TOGGLE_ACTIVATION_STATUS="toggle-activation-status"}(Be||(Be={})),function(e){e.ACTIVATE="Activate Requestly",e.DEACTIVATE="Deactivate Requestly"}(je||(je={}));const Ve=e=>{chrome.contextMenus.update(Be.TOGGLE_ACTIVATION_STATUS,{title:e?je.DEACTIVATE:je.ACTIVATE}),e?Fe.markExtensionEnabled():Fe.markExtensionDisabled()},We=e=>{e.reason===chrome.runtime.OnInstalledReason.INSTALL&&chrome.tabs.create({url:h.WEB_URL+"/extension-installed"})},Xe=async e=>{const t=await ue("sessionRecordingConfig");if(!t)return null;let a=t?.pageSources||[];if(await Ie()){if("autoRecording"in t){if(!t?.autoRecording.isActive)return null;t?.autoRecording.mode===c.ALL_PAGES&&(a=[{value:"*",key:s.URL,isActive:!0,operator:r.WILDCARD_MATCHES}])}if(a.some((t=>T(t,e))))return t}return null},$e=e=>{chrome.tabs.create({url:`${h.WEB_URL}/sessions/draft/${e}`})},Qe=(e,t)=>chrome.tabs.sendMessage(e,{action:K,payload:t}),Ye=(e,t)=>{chrome.tabs.sendMessage(e,{action:Z},(()=>{He.removeData(e,Ge.SESSION_RECORDING)})),t&&$e(e)},Je=(e,t=[],a=!1)=>{const s=()=>{const a=document.createElement("script");t.length?t.forEach((({name:e,value:t})=>{a.setAttribute(e,t??"")})):a.type="text/javascript",a.classList.add("__RQ_SCRIPT__"),a.appendChild(document.createTextNode(e));(document.head||document.documentElement).appendChild(a)};a&&"loading"===document.readyState?document.addEventListener("DOMContentLoaded",s):s()},ze=(e,t=[],a=!1)=>new Promise((s=>{const r=()=>{const a=document.createElement("script");t.length?t.forEach((({name:e,value:t})=>{a.setAttribute(e,t??"")})):a.type="text/javascript",a.classList.add("__RQ_SCRIPT__"),a.src=e,a.onload=()=>s();(document.head||document.documentElement).appendChild(a)};a&&"loading"===document.readyState?document.addEventListener("DOMContentLoaded",r):r()})),Ke=function(e,t=[]){var a=document.createElement("style");a.appendChild(document.createTextNode(e)),t.length&&t.forEach((({name:e,value:t})=>{a.setAttribute(e,t??"")})),a.classList.add("__RQ_SCRIPT__");(document.head||document.documentElement).appendChild(a)},Ze=function(e,t=[]){var a=document.createElement("link");t.length?t.forEach((({name:e,value:t})=>{a.setAttribute(e,t??"")})):(a.type="text/css",a.rel="stylesheet"),a.href=e,a.classList.add("__RQ_SCRIPT__");(document.head||document.documentElement).appendChild(a)},et=(e,t)=>new Promise((a=>{let s;s=e.codeType===d.JS?e.type===l.URL?ze:Je:e.type===l.URL?Ze:Ke;const r=e.attributes??[];chrome.scripting.executeScript({target:t,func:s,args:[e.value,r,"afterPageLoad"===e.loadTime],world:"MAIN",injectImmediately:!0},a)})),tt=(e,t)=>new Promise((a=>{chrome.scripting.executeScript({target:t,files:[e],world:"MAIN",injectImmediately:!0},a)})),at=async()=>{const e=!await Ie();return he(Ee.IS_EXTENSION_ENABLED,e),Ve(e),e||Object.values(He.getTabs()).forEach((({id:e})=>{e&&He.getData(e,Ge.SESSION_RECORDING)&&Ye(e,!1)})),e};const st=new class{constructor(){}getExecutedRules=async e=>{const t=[...He.getPageData(e,Ge.RULES_EXECUTION_LOGS,[]),...He.getData(e,Ge.RULES_EXECUTION_LOGS,[])].map((e=>e.ruleId)).filter((e=>!!e)),a=Array.from(new Set(t));return await Le.getRules(a)};processTabCachedRulesExecutions=e=>{(He.getData(e,Ge.RULES_EXECUTION_LOGS,[])||[]).forEach((e=>{this.onRuleExecuted({id:e.ruleId},e.requestDetails)})),He.removeData(e,Ge.RULES_EXECUTION_LOGS)};onRuleExecuted=(e,t,a)=>{const s=a?ke.TAB:ke.PAGE;Fe.markRuleExecuted(t.tabId),chrome.tabs.sendMessage(t.tabId,{action:ae,rule:e});const r=He.getDataForScope(s,t.tabId,Ge.RULES_EXECUTION_LOGS,[])||[];r.push({ruleId:e.id,requestDetails:t}),He.setDataForScope(s,t.tabId,Ge.RULES_EXECUTION_LOGS,r)}};var rt,nt;!function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.PATCH="PATCH",e.DELETE="DELETE",e.HEAD="HEAD",e.OPTIONS="OPTIONS"}(rt||(rt={})),function(e){e.RAW="text/plain",e.JSON="application/json",e.FORM="application/x-www-form-urlencoded"}(nt||(nt={}));async function ot(e){const t=e.method||"GET",a=new Headers,s=e.body;let r=e.url,n=s;if(e?.queryParams.length){const t=new URL(e.url),a=new URLSearchParams(t.search);e.queryParams.forEach((({key:e,value:t})=>{a.append(e,t)})),t.search=a.toString(),r=t.toString()}if(e?.headers.forEach((({key:e,value:t})=>{a.append(e,t)})),((e,t,a)=>![rt.GET,rt.HEAD].includes(e)&&t===nt.FORM)(e.method,e.contentType)){const e=new FormData;s?.forEach((({key:t,value:a})=>{e.append(t,a)}));const t=new URLSearchParams;for(const[a,s]of e.entries())t.append(a,s);n=t}try{const e=performance.now(),s=await fetch(r,{method:t,headers:a,body:n,credentials:"omit"}),o=performance.now()-e,i=[];for(const[e,t]of s.headers.entries())i.push({key:e,value:t});const c=await s.blob(),u=i.find((e=>"content-type"===e.key.toLowerCase()))?.value;let d;if(u?.includes("image/")){const e=e=>new Promise(((t,a)=>{const s=new FileReader;s.onload=e=>t(e.target.result),s.onerror=()=>a(null),s.readAsDataURL(e)}));d=await e(c)}else d=await c.text();return{body:d,time:o,headers:i,status:s.status,statusText:s.statusText,redirectedUrl:s.url!==r?s.url:""}}catch(e){return null}}var it;!function(e){e.FORWARD_IGNORED_HEADERS="forwardIgnoredHeaders",e.INITIATOR_DOMAIN="initiatorDomain",e.CSP_ERROR="cspError"}(it||(it={}));const ct=Object.values(chrome.declarativeNetRequest.ResourceType),ut=async e=>{const t=new Set;for(;e.addRules||e.removeRuleIds;){const a=e.addRules?.filter((e=>!t.has(e?.rqRuleId)))??[],s=e.removeRuleIds??[];try{await chrome.declarativeNetRequest.updateDynamicRules({addRules:a.map((e=>{const t={...e};return delete t.rqRuleId,t})),removeRuleIds:s});break}catch(e){const s=e.message.match(/Rule with id (\d+)/),r=s&&parseInt(s[1]),n=a.find((e=>e.id===r))?.rqRuleId;if(s&&n&&t.add(n),Dt({action:$,error:e.message,rqRuleId:n}),!s){console.error(`Error updating dynamic rules: ${e.message}`);break}}}},dt=async()=>{const e=await(async e=>{const a=await Oe(),s=await we();return a.filter((a=>!(!a.status||a.status===t.INACTIVE)&&((!e||a.ruleType===e)&&(!a.groupId||s.find((e=>e.id===a.groupId)).status===t.ACTIVE))))})(),a=[],s=await be();e.forEach((e=>{const t=e.extensionRules;t?.length&&t.forEach((t=>{t.condition.resourceTypes?.length||(t.condition.resourceTypes=ct),t.condition.resourceTypes?.length&&t.condition.excludedResourceTypes?.length&&(t.condition.resourceTypes=t.condition.resourceTypes.filter((e=>!t.condition.excludedResourceTypes.includes(e)))),t.condition.excludedInitiatorDomains.push(...s),t.condition.excludedRequestDomains.push(...s);const r=a.length+1;a.push({...t,id:r,rqRuleId:e.id})}))})),await ut({addRules:a})},lt=async()=>{await(async()=>{const e=await chrome.declarativeNetRequest.getDynamicRules();return ut({removeRuleIds:e.map((e=>e.id))})})();await Ie()&&await dt()},Et=async()=>{Ce(((e,t)=>{let a;return function(...s){clearTimeout(a),a=setTimeout((()=>e(...s)),t)}})(lt,500)),me(Ee.IS_EXTENSION_ENABLED,(()=>{lt(),(async()=>{const e=await chrome.declarativeNetRequest.getSessionRules();chrome.declarativeNetRequest.updateSessionRules({removeRuleIds:e.map((e=>e.id))})})()})),lt(),Ae((()=>{lt()}))},pt=async(e,t,a,s)=>{let r=parseInt(`${Date.now()%1e6}${Math.floor(1e3*Math.random())}`);const n=He.getData(e,Ge.SESSION_RULES_MAP)??{},o=n?.[s]??{};let i=[];return o[t]&&(r=o[t],i.push(r)),He.setData(e,Ge.SESSION_RULES_MAP,{...n,[s]:{...o,[t]:r}}),chrome.declarativeNetRequest.updateSessionRules({addRules:[{id:r,...a}],removeRuleIds:i})},ht=["Authorization"],mt=(e,t)=>Object.keys(e).some((e=>e.toLowerCase()===t.toLowerCase())),Rt="rq_request_initiator_origin()";const gt=new class{constructor(){}onBeforeAJAXRequest=async(e,t)=>{const s=await Le.getEnabledRules();if(0===s.length)return;const r=s.filter((e=>e.ruleType===a.REDIRECT||e.ruleType===a.REPLACE)),n=s.filter((e=>e.ruleType===a.HEADERS));await(async(e,t,a)=>{if(!ht.some((e=>mt(t.requestHeaders,e))))return;const{isApplied:s,destinationUrl:r}=y(a,t)??{};if(!s)return;const n=ht.map((e=>{const a=Object.keys(t.requestHeaders).find((t=>t.toLowerCase()===e.toLowerCase()));return a?{name:a,value:t.requestHeaders[a]}:null})).filter((e=>null!==e)),o=r;return pt(e,t.url,{action:{requestHeaders:n.map((e=>({header:e.name,value:e.value,operation:chrome.declarativeNetRequest.HeaderOperation.SET}))),type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS},condition:{urlFilter:`|${o}`,resourceTypes:[chrome.declarativeNetRequest.ResourceType.XMLHTTPREQUEST],tabIds:[e],requestMethods:[t.method.toLowerCase()],excludedInitiatorDomains:["requestly.io","requestly.com"]}},it.FORWARD_IGNORED_HEADERS)})(e,t,r),await(async(e,t,a)=>{const{isApplied:s,matchedPair:r}=y(a,t)??{};if(!s)return;const n={Request:{},Response:{}};r.modifications?.Request?.length&&r.modifications.Request.forEach((e=>{e.value===Rt&&(n.Request[e.header]=t.initiator)})),r.modifications?.Response?.length&&r.modifications.Response.forEach((e=>{e.value===Rt&&(n.Response[e.header]=t.initiator)}));const o={};Object.keys(n.Request).length&&(o.requestHeaders=Object.entries(n.Request).map((([e,t])=>({header:e,value:t,operation:chrome.declarativeNetRequest.HeaderOperation.SET})))),Object.keys(n.Response).length&&(o.responseHeaders=Object.entries(n.Response).map((([e,t])=>({header:e,value:t,operation:chrome.declarativeNetRequest.HeaderOperation.SET})))),Object.keys(o).length&&await pt(e,t.url,{action:{...o,type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS},condition:{urlFilter:`|${t.url}|`,resourceTypes:[chrome.declarativeNetRequest.ResourceType.XMLHTTPREQUEST],tabIds:[e],requestMethods:r?.source?.filters?.[0]?.requestMethod?.map((e=>e.toLowerCase()))??void 0,excludedInitiatorDomains:["requestly.io","requestly.com"]}},it.INITIATOR_DOMAIN)})(e,t,n)};onErrorOccurred=async(e,t)=>{0!==(await Le.getEnabledRules()).length&&await(async(e,t)=>{await pt(e,t.initiator,{action:{type:chrome.declarativeNetRequest.RuleActionType.MODIFY_HEADERS,responseHeaders:[{header:"Content-Security-Policy",operation:chrome.declarativeNetRequest.HeaderOperation.REMOVE}]},condition:{urlFilter:t.initiator,resourceTypes:[chrome.declarativeNetRequest.ResourceType.SUB_FRAME,chrome.declarativeNetRequest.ResourceType.MAIN_FRAME],tabIds:[e],excludedInitiatorDomains:["requestly.io","requestly.com"]}},it.CSP_ERROR)})(e,t)}};let Tt;const It=new Uint8Array(16);function St(){if(!Tt&&(Tt="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!Tt))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return Tt(It)}const ft=[];for(let e=0;e<256;++e)ft.push((e+256).toString(16).slice(1));var bt={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function yt(e,t,a){if(bt.randomUUID&&!t&&!e)return bt.randomUUID();const s=(e=e||{}).random||(e.rng||St)();if(s[6]=15&s[6]|64,s[8]=63&s[8]|128,t){a=a||0;for(let e=0;e<16;++e)t[a+e]=s[e];return t}return function(e,t=0){return ft[e[t+0]]+ft[e[t+1]]+ft[e[t+2]]+ft[e[t+3]]+"-"+ft[e[t+4]]+ft[e[t+5]]+"-"+ft[e[t+6]]+ft[e[t+7]]+"-"+ft[e[t+8]]+ft[e[t+9]]+"-"+ft[e[t+10]]+ft[e[t+11]]+ft[e[t+12]]+ft[e[t+13]]+ft[e[t+14]]+ft[e[t+15]]}(s)}const At=async(e,t,a)=>{const s=await ue(ne)??{},r=Object.values(s).filter((t=>t.ruleId===e)).sort(((e,t)=>e.timestamp<t.timestamp?1:e.timestamp>t.timestamp?-1:0));r.length>2&&delete s[r[2].id];const n=yt();return s[n]={timestamp:Date.now(),ruleId:e,appliedStatus:a,url:t,id:n},await ce(ne,s),n},Dt=async e=>{const t=await(async()=>{const e=Re();let t=[];for(const a of e){const e=await chrome.tabs.query({url:a+"/*"});t=[...t,...e]}return t})();return Promise.all(t.map((({id:t})=>chrome.tabs.sendMessage(t,e))))},_t=()=>{chrome.runtime.onMessage.addListener(((e,t,s)=>{switch(e.action){case O:Ie().then((e=>{var s,r;e&&(s=t.tab?.id,r=t.frameId,tt("libs/customElements.js",{tabId:s,frameIds:[r]}),(async(e,t,s,r)=>{if(ge(s))return;if(await ye(r)||await ye(s))return;const n=await Le.getEnabledRules(a.SCRIPT),i=[],c=[];n.forEach((e=>{S(e,{url:s,type:0===t?o.MainDocument:o.IFrameDocument,method:"GET",initiator:r}).isApplied&&(c.push(e),e.pairs.forEach((e=>{e.scripts.forEach((e=>{i.push(e)}))})))}));for(let a of i)await et(a,{tabId:e,frameIds:[t]});c.length>0&&c.forEach((t=>{st.onRuleExecuted(t,{url:s,tabId:e})}))})(t.tab?.id,t.frameId,t.url,t.tab?.url))}));break;case H:st.processTabCachedRulesExecutions(t.tab.id),(e=>{const t=He.getData(e.id,Ge.TEST_RULE_DATA);t?chrome.tabs.sendMessage(e.id,{action:ee,ruleId:t.ruleId,record:t.record}):chrome.tabs.sendMessage(e.id,{action:te})})(t.tab),(async(e,t)=>{let a=He.getData(e.id,Ge.SESSION_RECORDING);if(a){if(!a.explicit&&!await Xe(a.url))return void Ye(e.id,!1)}else{const t=await Xe(e.url);if(t){a={config:t,url:e.url};const s=t?.autoRecording?.mode;a.showWidget=s===c.CUSTOM,s===c.ALL_PAGES&&(a.markRecordingIcon=!1),He.setData(e.id,Ge.SESSION_RECORDING,a)}}a&&Qe(e.id,a).then((()=>{He.setData(e.id,Ge.SESSION_RECORDING,{...a,notify:!1,previousSession:null})}))})(t.tab,t.frameId);break;case k:return(async(e,t)=>{await tt("libs/requestly-web-sdk.js",{tabId:e,frameIds:[t]})})(t.tab.id,t.frameId).then((()=>s())),!0;case Y:u=t.tab.id,e.payload.markRecordingIcon&&Fe.markRecording(u);break;case J:(e=>{Fe.markNotRecording(e)})(t.tab.id);break;case N:(async(e,t=!0)=>{const a=await Xe(e.url),s=!!He.getData(e.id,Ge.SESSION_RECORDING);if(!a&&s)return;const r={explicit:!0,showWidget:t};He.setData(e.id,Ge.SESSION_RECORDING,r),Qe(e.id,r)})(e.tab??t.tab,e.showWidget);break;case v:i=e.url,chrome.tabs.create({url:i},(e=>{He.setData(e.id,Ge.SESSION_RECORDING,{notify:!0,explicit:!0,showWidget:!0})}));break;case U:Ye(e.tabId??t.tab.id,e.openRecording);break;case _:return((e,t)=>{chrome.tabs.sendMessage(e,{action:z},{frameId:0},t)})(e.tabId,s),!0;case D:return(async()=>{const[e,t]=await Promise.all([Oe(),we()]);return{rules:e,groups:t}})().then(s),!0;case w:return ot(e.apiRequest).then(s),!0;case C:return st.getExecutedRules(e.tabId??t.tab.id).then(s),!0;case L:return(async()=>0===(await Oe()).length)().then(s),!0;case x:return Ie().then(s),!0;case q:return at().then(s),!0;case P:$e(e.tabId??t.tab?.id);break;case M:((e,t)=>{const a=He.getData(e,Ge.SESSION_RECORDING);a&&He.setData(e,Ge.SESSION_RECORDING,{...a,previousSession:t.session,widgetPosition:t.widgetPosition,recordingStartTime:t.recordingStartTime})})(t.tab.id,e.payload);break;case G:return gt.onBeforeAJAXRequest(t.tab.id,e.requestDetails).then(s),!0;case F:return gt.onErrorOccurred(t.tab.id,e.requestDetails).then(s),!0;case V:r=e,n=t.tab.id,He.createNewTab(r.url,n,(e=>{He.setData(e.id,Ge.TEST_RULE_DATA,{url:r.url,ruleId:r.ruleId,record:r.record})}));break;case B:((e,t)=>{const a=He.getData(t.id,Ge.TEST_RULE_DATA),s=a.url??t.url;At(e.ruleId,s,e.appliedStatus).then((s=>{He.focusTab(t.openerTabId)?chrome.tabs.sendMessage(t.openerTabId,{action:j,testReportId:s,testPageTabId:t.id,record:a.record,appliedStatus:e.appliedStatus}):chrome.tabs.create({url:`${h.WEB_URL}/rules/editor/edit/${e.ruleId}`},(r=>{He.ensureTabLoadingComplete(r.id).then((()=>{chrome.tabs.sendMessage(r.id,{action:j,testReportId:s,testPageTabId:t.id,record:a.record,appliedStatus:e.appliedStatus})}))}))}))})(e,t.tab);break;case W:const d={...e.requestDetails,tabId:e.requestDetails?.tabId||t.tab?.id};st.onRuleExecuted(e.rule,d);break;case Q:if(!e.tabUrl){s(!1);break}return ye(e.tabUrl).then((e=>s(e))).catch((()=>s(!1))),!0;case X:Dt({action:se})}var r,n,i,u;return!1}))},Ot=async e=>{if("active"!==e?.documentLifecycle)return;let t="main_frame"===e.type;await ye(e.initiator)||await ye(e.url)||Le.getEnabledRules().then((s=>{s.forEach((s=>{switch(s.ruleType){case a.REDIRECT:case a.REPLACE:case a.QUERYPARAM:case a.CANCEL:case a.DELAY:const{isApplied:r}=S(s,{url:e.url,method:e.method,type:e.type,initiator:e.initiator});r&&st.onRuleExecuted(s,e,t)}}))}))},wt=async e=>{let t="main_frame"===e.type;await ye(e.initiator)||await ye(e.url)||Le.getEnabledRules().then((s=>{s.forEach((s=>{switch(s.ruleType){case a.HEADERS:case a.USERAGENT:const{isApplied:r,matchedPair:n}=S(s,{url:e.url,method:e.method,type:e.type,initiator:e.initiator});r&&n.modifications?.Request&&n.modifications?.Request?.length>0&&st.onRuleExecuted(s,e,t)}}))}))},Ct=async e=>{let t="main_frame"===e.type;await ye(e.initiator)||await ye(e.url)||Le.getEnabledRules().then((s=>{s.forEach((s=>{if(s.ruleType===a.HEADERS){const{isApplied:a,matchedPair:r}=S(s,{url:e.url,method:e.method,type:e.type,initiator:e.initiator});a&&r.modifications?.Response&&r.modifications?.Response?.length>0&&st.onRuleExecuted(s,e,t)}}))}))},Lt=()=>{if(chrome.webRequest.onBeforeRequest.hasListener(Ot)||chrome.webRequest.onBeforeRequest.addListener(Ot,{urls:["<all_urls>"]}),!chrome.webRequest.onBeforeSendHeaders.hasListener(wt)){chrome.webRequest.onBeforeSendHeaders.addListener(wt,{urls:["<all_urls>"]},["requestHeaders"])}if(!chrome.webRequest.onHeadersReceived.hasListener(Ct)){chrome.webRequest.onHeadersReceived.addListener(Ct,{urls:["<all_urls>"]},["responseHeaders"])}},Nt=()=>{Ie().then((e=>{e&&Lt()})),me(Ee.IS_EXTENSION_ENABLED,(e=>{e?Lt():(chrome.webRequest.onBeforeRequest.removeListener(Ot),chrome.webRequest.onBeforeSendHeaders.removeListener(wt),chrome.webRequest.onHeadersReceived.removeListener(Ct))}))};(async()=>{(async()=>{console.log("[initClientHandler]");const e=await Ie();xe(e),me(Ee.IS_EXTENSION_ENABLED,(e=>{console.log("[initClientHandler]","onVariableChange",{extensionStatus:e}),xe(e)})),Ae((()=>{Pe().then((()=>{xe(e)}))}))})(),(async()=>{let e=await Ie();me(Ee.IS_EXTENSION_ENABLED,(t=>{e=t})),chrome.webNavigation.onCommitted.addListener((async t=>{e&&Me(t.tabId,t.frameId)})),Le.onRuleOrGroupChange((async()=>{e&&chrome.tabs.query({},(e=>{e.forEach((e=>{Me(e.id,void 0)}))}))}))})(),chrome.commands.onCommand.addListener((e=>{"reload"===e&&chrome.runtime.reload()})),chrome.runtime.onInstalled.addListener(We),chrome.runtime.setUninstallURL(h.WEB_URL+"/goodbye/"),Et(),_t(),(async()=>{chrome.contextMenus.removeAll(),chrome.contextMenus.create({id:Be.TOGGLE_ACTIVATION_STATUS,title:je.DEACTIVATE,contexts:["action"]}),chrome.contextMenus.onClicked.addListener((async e=>{const t=await Ie();e.menuItemId===Be.TOGGLE_ACTIVATION_STATUS&&he(Ee.IS_EXTENSION_ENABLED,!t)}));const e=await Ie();Ve(e),me(Ee.IS_EXTENSION_ENABLED,Ve)})(),Nt()})()}();
