!function(){"use strict";const e="handshakeClient",t="getExecutedRules",n="startRecordingExplicitly",s="stopRecording",i="watchRecording",o="cacheRecordedSessionOnPageUnload",r="initSessionRecorder",a="clientPageLoaded",c="onBeforeAjaxRequest",d="onErrorOccurred",l="saveTestRuleResult",u="notifyTestRuleReportUpdated",g="ruleExecuted",p="ruleSaveError",m="notifySessionRecordingStarted",E="notifySessionRecordingStopped",h="isRecordingSession",w="getTabSession",R="startRecording",y="stopRecording",T="isExplicitRecordingSession",f="notifyPageLoadedFromCache",S="onBeforeAjaxRequest:processed",C="onErrorOccurred:processed",v="startExplicitRuleTesting",I="startImplicitRuleTesting",A="notifyRuleExecuted",L="notifyRecordUpdated",D="local",M="implicit_rule_testing_widget_config",q={};let b=!1;const P={isRecording:!1,isExplicitRecording:!1,markRecordingIcon:!1,widgetPosition:null,recordingStartTime:null,showWidget:!1},_=()=>{window.addEventListener("pageshow",(e=>{e.persisted&&chrome.runtime.sendMessage({action:f,payload:{isRecordingSession:P.isRecording}})}))},O=async e=>{if(!e)return;await(async()=>new Promise((e=>{b&&e(),chrome.runtime.sendMessage({action:r},(()=>{b=!0,e()}))})))();const{notify:t,markRecordingIcon:n=!0,explicit:s=!1,recordingStartTime:i=Date.now(),showWidget:o,widgetPosition:a,previousSession:c}=e,d=window.top!==window;d||x(),N("startRecording",{relayEventsToTop:d,console:!0,network:!0,maxDuration:60*(e.maxDuration||5)*1e3,previousSession:d?null:c}),P.isExplicitRecording=s,P.markRecordingIcon=n,P.showWidget=o,P.widgetPosition=a,P.recordingMode=s?"manual":"auto",t&&j(),s&&(P.recordingStartTime=i,G())},x=()=>{chrome.runtime.onMessage.addListener(((e,t,n)=>{switch(e.action){case h:n(P.isRecording);break;case w:return N("getSessionData",null,(e=>{n({...e,recordingMode:P.recordingMode})})),!0;case T:n(P.isExplicitRecording);break;case y:N("stopRecording",null)}return!1})),window.addEventListener("message",(function(e){e.source===window&&"requestly:client"===e.data.source&&(e.data.response?k(e.data.action,e.data.payload):"sessionRecordingStarted"===e.data.action?(P.isRecording=!0,chrome.runtime.sendMessage({action:m,payload:{markRecordingIcon:P.markRecordingIcon}}),P.showWidget&&(P.isExplicitRecording?U():V())):"sessionRecordingStopped"===e.data.action&&(P.isRecording=!1,P.isExplicitRecording=!1,P.markRecordingIcon=!1,H(),G(),chrome.runtime.sendMessage({action:E})))})),window.addEventListener("beforeunload",(()=>{N("getSessionData",null,(e=>{chrome.runtime.sendMessage({action:o,payload:{session:e,widgetPosition:P.widgetPosition,recordingMode:P.recordingMode,recordingStartTime:P.recordingStartTime}})}))}))},k=(e,t)=>{q[e]?.(t),delete q[e]},N=(e,t,n)=>{window.postMessage({source:"requestly:extension",action:e,payload:t},window.location.href),n&&(q[e]=n)},U=()=>{let e=F();e||(e=document.createElement("rq-session-recording-widget"),e.classList.add("rq-element"),document.documentElement.appendChild(e),e.addEventListener("stop",(()=>{chrome.runtime.sendMessage({action:s,openRecording:!0})})),e.addEventListener("discard",(()=>{chrome.runtime.sendMessage({action:s})})),e.addEventListener("moved",(e=>{P.widgetPosition=e.detail})));const t=Date.now()-P.recordingStartTime,n=t<=3e5?t:null;e.dispatchEvent(new CustomEvent("show",{detail:{currentRecordingTime:n,position:P.widgetPosition}}))},H=()=>{const e=F();e?.dispatchEvent(new CustomEvent("hide"))},F=()=>document.querySelector("rq-session-recording-widget"),V=()=>{const e="rq-session-recording-auto-mode-widget";let t=document.querySelector(e);t||(t=document.createElement(e),t.classList.add("rq-element"),document.documentElement.appendChild(t),t.addEventListener("watch",(()=>{chrome.runtime.sendMessage({action:i})})),t.addEventListener("moved",(e=>{P.widgetPosition=e.detail}))),t.dispatchEvent(new CustomEvent("show",{detail:{position:P.widgetPosition}}))},G=()=>{let e=document.querySelector("rq-session-recording-auto-mode-widget");e?.dispatchEvent(new CustomEvent("hide"))},j=()=>{const e=document.createElement("rq-toast");e.classList.add("rq-element"),e.setAttribute("heading","Requestly is recording session on this tab!"),e.setAttribute("icon-path",chrome.runtime.getURL("resources/images/128x128.png"));const t='\n  <div slot="content">\n    You can save up to last 5 minutes anytime by clicking on Requestly extension icon to save & upload activity for this tab.\n  </div>\n  ';try{e.innerHTML=t}catch(n){const s=window.trustedTypes?.createPolicy?.("rq-html-policy",{createHTML:e=>e});e.innerHTML=s.createHTML(t)}document.documentElement.appendChild(e)},W=async()=>{const e=await(async()=>new Promise((e=>{chrome.storage[D].get(null,e)})))();return Object.values(e).filter((e=>!!e))},Q=async e=>new Promise((t=>{chrome.storage[D].get(e,(n=>t(n[e])))}));var Y;!function(e){e[e.MODIFIED=0]="MODIFIED",e[e.CREATED=1]="CREATED",e[e.DELETED=2]="DELETED"}(Y||(Y={}));const z=(e,t)=>{chrome.storage.onChanged.addListener(((n,s)=>{if(s===D){const s=[];Object.entries(n).forEach((([t,n])=>{let i,o;if(void 0!==n.newValue)i=void 0!==n.oldValue?Y.MODIFIED:Y.CREATED,o=n.newValue;else{if(void 0===n.oldValue)return;i=Y.DELETED,o=n.oldValue}e?.changeTypes?.length&&!e.changeTypes.includes(i)||e?.keyFilter&&t!==e.keyFilter||e?.valueFilter&&!e.valueFilter(o)||s.push({changeType:i,key:t,...n})})),s.length&&t(s)}}))};var B;!function(e){e.IS_EXTENSION_ENABLED="isExtensionEnabled",e.EXTENSION_RULES_COUNT="extensionRulesCount",e.TEST_SCRIPT="testScript"}(B||(B={}));var X,$,J,K,Z,ee,te,ne,se,ie,oe,re,ae="https://app.requestly.io";!function(e){e.GROUP="group",e.RULE="rule"}(X||(X={})),function(e){e.ACTIVE="Active",e.INACTIVE="Inactive"}($||($={})),function(e){e.REDIRECT="Redirect",e.CANCEL="Cancel",e.REPLACE="Replace",e.HEADERS="Headers",e.USERAGENT="UserAgent",e.SCRIPT="Script",e.QUERYPARAM="QueryParam",e.RESPONSE="Response",e.REQUEST="Request",e.DELAY="Delay"}(J||(J={})),function(e){e.URL="Url",e.HOST="host",e.PATH="path"}(K||(K={})),function(e){e.EQUALS="Equals",e.CONTAINS="Contains",e.MATCHES="Matches",e.WILDCARD_MATCHES="Wildcard_Matches"}(Z||(Z={})),function(e){e.PAGE_DOMAINS="pageDomains",e.REQUEST_METHOD="requestMethod",e.RESOURCE_TYPE="resourceType",e.REQUEST_PAYLOAD="requestPayload"}(ee||(ee={})),function(e){e.XHR="xmlhttprequest",e.JS="script",e.CSS="stylesheet",e.Image="image",e.Media="media",e.Font="font",e.WebSocket="websocket",e.MainDocument="main_frame",e.IFrameDocument="sub_frame"}(te||(te={})),function(e){e.GET="GET",e.POST="POST",e.PUT="PUT",e.DELETE="DELETE",e.PATCH="PATCH",e.OPTIONS="OPTIONS",e.CONNECT="CONNECT",e.HEAD="HEAD"}(ne||(ne={})),function(e){e.CUSTOM="custom",e.ALL_PAGES="allPages"}(se||(se={})),function(e){e.SESSION_RECORDING_CONFIG="sessionRecordingConfig"}(ie||(ie={})),function(e){e.JS="js",e.CSS="css"}(oe||(oe={})),function(e){e.URL="url",e.CODE="code"}(re||(re={}));const ce=e=>e&&(!!e.ruleType||e.objectType===X.RULE),de=e=>e&&e.objectType===X.GROUP,le=async()=>(await W()).filter(ce),ue=async()=>(await W()).filter(de);const ge=new class{rules=[];groups=[];isInitialized=!1;listeners={};updateCachedRules=async()=>{this.rules=await le(),this.groups=await ue(),this.isInitialized=!0};constructor(){var e;this.updateCachedRules(),e=()=>{this.updateCachedRules().then((()=>{this.listeners&&Object.values(this.listeners).forEach((e=>e?.()))}))},z({valueFilter:ce},(t=>{t.some((({changeType:e,oldValue:t,newValue:n})=>e===Y.CREATED&&n.status===$.ACTIVE||e===Y.DELETED&&t.status===$.ACTIVE||e===Y.MODIFIED))&&e()})),z({valueFilter:de,changeTypes:[Y.MODIFIED]},(t=>{t.some((({oldValue:e,newValue:t})=>e.status!==t.status))&&e()}))}onRuleOrGroupChange=e=>{const t=Date.now();return this.listeners[t]=e,()=>{this.listeners[t]&&delete this.listeners[t]}};getAllRules=async()=>this.isInitialized?this.rules:le();getAllGroups=async()=>this.isInitialized?this.groups:ue();getRule=async e=>this.getAllRules().then((t=>t.find((t=>t.id===e))));getRules=async e=>this.getAllRules().then((t=>t.filter((t=>e.includes(t.id)))));getEnabledRules=async e=>{const t=await this.getAllRules(),n=await this.getAllGroups();return t.filter((t=>{if(!t.status||t.status===$.INACTIVE)return!1;if(e&&t.ruleType!==e)return!1;if(!t.groupId)return!0;return n.find((e=>e.id===t.groupId)).status===$.ACTIVE}))}};const pe=new class{constructor(){this.initListeners()}initListeners=()=>{chrome.runtime.onMessage.addListener(((e,t,n)=>{if(e.action===A)this.onRuleExecuted(e.rule,e.requestDetails)}))};getExecutedRules=async()=>chrome.runtime.sendMessage({action:t});onRuleExecuted=(e,t)=>{Ce(e)}};let me=!1,Ee=!1,he=null;const we=async e=>{if(document.querySelector("rq-explicit-test-rule-widget"))return;const t=await ge.getRule(e),{name:n}=t,s=document.createElement("rq-explicit-test-rule-widget");s.classList.add("rq-element"),s.setAttribute("rule-id",e),s.setAttribute("rule-name",n),Re(s,t),s.setAttribute("applied-status","false"),document.documentElement.appendChild(s),s.addEventListener("view-results",(()=>{chrome.runtime.sendMessage({action:l,ruleId:e,appliedStatus:"true"===s?.getAttribute("applied-status")})}));const i=await pe.getExecutedRules();i&&i?.forEach((e=>{ye(e.id)}))},Re=(e,t)=>{const{ruleType:n}=t;switch(n){case"Response":e.setAttribute("rq-test-rule-text",'Response Modifications will not show up in the browser network devtools due to technical contraints. Checkout docs for more <a target="_blank" href="https://developers.requestly.io/http-rules/modify-response-body/">details</a>.');break;case"Headers":t.pairs.some((e=>e?.modifications?.Response?.length>0))&&e.setAttribute("rq-test-rule-text",'Response Header Modifications will not show up in the browser network devtools due to technical constraints. Checkout docs for more <a target="_blank" href="https://developers.requestly.io/http-rules/modify-headers/">details</a>.');break;default:return}},ye=e=>{const t=document.querySelector("rq-explicit-test-rule-widget");t&&"false"===t?.getAttribute("applied-status")&&(t.getAttribute("rule-id")===e&&t.setAttribute("applied-status","true"),t.dispatchEvent(new CustomEvent("new-rule-applied",{detail:{appliedRuleId:e}})))},Te=async()=>{if(document.querySelector("rq-implicit-test-rule-widget"))return;const e=document.createElement("rq-implicit-test-rule-widget");e.classList.add("rq-element"),e.style.display="none",e.addEventListener("view_rule_in_editor",(e=>{window.open(`${ae}/rules/editor/edit/${e.detail.ruleId}`,"_blank")})),e.addEventListener("open_app_settings",(()=>{window.open(`${ae}/settings/global-settings`,"_blank")})),document.documentElement.appendChild(e);const t=await pe.getExecutedRules();t&&t?.forEach((e=>{fe(e)}))},fe=async e=>{let t=e.name,n=e.ruleType;if(!t||!n){const s=await ge.getRule(e.id);t=s.name,n=s.ruleType}if(!ve(n))return;const s=document.querySelector("rq-implicit-test-rule-widget");s&&(s.dispatchEvent(new CustomEvent("new-rule-applied",{detail:{appliedRuleId:e.id,appliedRuleName:t,appliedRuleType:n}})),s.style.display="block")},Se=async()=>{Q(M).then((e=>{e&&(he=e)}))},Ce=async e=>{me?fe(e):Ee&&ye(e.id)},ve=e=>{const t=he;return!(!t||!t.enabled)&&!(t.visibility===Ie.SPECIFIC&&!t.ruleTypes.includes(e))};var Ie;!function(e){e.ALL="all",e.SPECIFIC="specific"}(Ie||(Ie={}));const Ae={};const Le="content_script",De="source",Me=(e,t)=>{e.action&&(t&&((e,t)=>{if(!t)return;Ae[e.action+"_1"]=t,e.requestId=1})(e,t),e[De]=Le,window.postMessage(e,window.origin))};("html"===document.doctype?.name||document.contentType?.includes("html"))&&(chrome.runtime.onMessage.addListener(((e,t,n)=>{switch(e.action){case a:chrome.runtime.sendMessage({action:a});break;case u:case L:case p:Me(e)}})),(async(e,t)=>{return await Q((n=e,`rq_var_${n}`))??t;var n})(B.IS_EXTENSION_ENABLED,!0).then((t=>{t&&(chrome.runtime.sendMessage({action:e}),chrome.runtime.onMessage.addListener((e=>{e.action===R&&O(e.payload)})),_(),window.addEventListener("message",(function(e){if(e.source===window&&"requestly:client"===e.data.source)switch(e.data.action){case"response_rule_applied":case"request_rule_applied":chrome.runtime.sendMessage({action:g,rule:e.data.rule,requestDetails:e.data.requestDetails});break;case c:chrome.runtime.sendMessage(e.data,(()=>{window.postMessage({source:"requestly:client",action:S},window.location.href)}));break;case d:chrome.runtime.sendMessage(e.data,(()=>{window.postMessage({source:"requestly:client",action:C},window.location.href)}))}})),Se(),chrome.runtime.onMessage.addListener(((e,t,s)=>{switch(e.action){case v:e.record&&chrome.runtime.sendMessage({action:n,showWidget:!1}),Ee=!0,we(e.ruleId);break;case I:he?.enabled&&(me=!0,Te())}return!1})))})))}();
